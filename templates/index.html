<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë¼ë””ì˜¤ í¸ì„±í‘œ ë° ìŠ¤íŠ¸ë¦¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>ğŸ“» ì‹¤ì‹œê°„ ë¼ë””ì˜¤ í¸ì„±í‘œ (Live Schedule)</h1>
        <p>ìµœê·¼ ë°ì´í„° ì—…ë°ì´íŠ¸: <span id="last-updated">{{ timestamp }}</span> (ìŠ¤íŠ¸ë¦¼ URLì€ ìµœëŒ€ 1ì‹œê°„ ìºì‹œë©ë‹ˆë‹¤)</p>
    </header>

    <div id="loading-message">
        <p>ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤... (ìµœì´ˆ ë¡œë”© ì‹œ Selenium êµ¬ë™ìœ¼ë¡œ ìµœëŒ€ 10-20ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</p>
        <div class="loader"></div>
    </div>
    
    <div id="schedule-container" style="display:none;">
        <table id="schedule-table">
            <thead>
                <tr id="time-header-row">
                    <th>ì±„ë„ëª…</th>
                </tr>
            </thead>
            <tbody id="schedule-body">
                </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchScheduleData();
        });

        async function fetchScheduleData() {
            const loading = document.getElementById('loading-message');
            const container = document.getElementById('schedule-container');
            const url = '/schedule'; 

            try {
                // API í˜¸ì¶œ
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    alert('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                    loading.innerHTML = '<p class="error-msg">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
                    return;
                }

                // 1. ì‹œê°„ í—¤ë” ìƒì„±
                const timeHeaderRow = document.getElementById('time-header-row');
                data.time_headers.forEach(time => {
                    const th = document.createElement('th');
                    th.textContent = time;
                    timeHeaderRow.appendChild(th);
                });

                // 2. í¸ì„±í‘œ ë³¸ë¬¸ ìƒì„±
                const scheduleBody = document.getElementById('schedule-body');
                data.schedule.forEach(channelData => {
                    const row = document.createElement('tr');
                    
                    // ì±„ë„ëª… (ë§í¬)
                    const nameCell = document.createElement('td');
                    const link = document.createElement('a');
                    
                    // ìŠ¤íŠ¸ë¦¼ URLì´ ìœ íš¨í•˜ë©´ ë§í¬ë¥¼ ê±¸ì–´ì¤ë‹ˆë‹¤.
                    if (channelData.stream_url && channelData.stream_url !== "URL_NOT_FOUND" && channelData.stream_url !== "URL_PROCESSING_ERROR") {
                        link.href = channelData.stream_url;
                        link.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                        link.title = "ìŠ¤íŠ¸ë¦¼ URL: " + channelData.stream_url;
                    } else {
                        link.href = "#";
                        link.title = "ìŠ¤íŠ¸ë¦¼ URL ì¶”ì¶œ ì‹¤íŒ¨ ë˜ëŠ” ê³ ì • URL ì—†ìŒ";
                        nameCell.classList.add('error');
                    }
                    
                    link.textContent = channelData.channel_name;
                    nameCell.appendChild(link);
                    row.appendChild(nameCell);

                    // í”„ë¡œê·¸ë¨ ë°ì´í„° ì…€ ì¶”ê°€
                    channelData.programs.forEach(program => {
                        if (!program.is_merged) {
                            const cell = document.createElement('td');
                            cell.textContent = program.title;
                            cell.colSpan = program.duration_slots; // ë³‘í•©ëœ ì…€ ì²˜ë¦¬
                            cell.classList.add(program.on_air ? 'on-air' : 'off-air');
                            row.appendChild(cell);
                        }
                    });

                    scheduleBody.appendChild(row);
                });

                // 3. ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°, í…Œì´ë¸” í‘œì‹œ
                loading.style.display = 'none';
                container.style.display = 'block';

            } catch (error) {
                console.error("Fetch Error:", error);
                loading.innerHTML = '<p class="error-msg">ì„œë²„ ì—°ê²° ë˜ëŠ” JSON ì²˜ë¦¬ ì‹¤íŒ¨.</p>';
            }
        }
    </script>
</body>
</html>
